import{P as k,O as u,p as D,E as f,A as p,C as T,S,b as C,d as x,g as U,B as N,s as v,f as I}from"./index-Cc5zWaob.js";const F={eip155:{native:{assetNamespace:"slip44",assetReference:"60"},defaultTokenNamespace:"erc20"},solana:{native:{assetNamespace:"slip44",assetReference:"501"},defaultTokenNamespace:"token"}};class _ extends Error{}function H(){const{sdkType:s,sdkVersion:t,projectId:n}=u.getSnapshot(),a=new URL("https://rpc.walletconnect.org/v1/json-rpc");return a.searchParams.set("projectId",n),a.searchParams.set("st",s),a.searchParams.set("sv",t),a.searchParams.set("source","fund-wallet"),a.toString()}async function l(s,t){const n=H(),{projectId:a}=u.getSnapshot(),r={jsonrpc:"2.0",id:1,method:s,params:{...t||{},projectId:a}},o=await(await fetch(n,{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"application/json"}})).json();if(o.error)throw new _(o.error.message);return o}async function L(s){return(await l("reown_getExchanges",s)).result}async function R(s){return(await l("reown_getExchangePayUrl",s)).result}async function O(s){return(await l("reown_getExchangeBuyStatus",s)).result}function P(s,t){const{chainNamespace:n,chainId:a}=k.parseCaipNetworkId(s),r=F[n];if(!r)throw new Error(`Unsupported chain namespace for CAIP-19 formatting: ${n}`);let c=r.native.assetNamespace,o=r.native.assetReference;return t!=="native"&&(c=r.defaultTokenNamespace,o=t),`${`${n}:${a}`}/${c}:${o}`}const W={network:"eip155:1",asset:"native",metadata:{name:"Ethereum",symbol:"ETH",decimals:18}},$={network:"eip155:8453",asset:"native",metadata:{name:"Ethereum",symbol:"ETH",decimals:18}},j={network:"eip155:8453",asset:"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913",metadata:{name:"USD Coin",symbol:"USDC",decimals:6}},q={network:"eip155:84532",asset:"native",metadata:{name:"Ethereum",symbol:"ETH",decimals:18}},B={network:"eip155:1",asset:"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",metadata:{name:"USD Coin",symbol:"USDC",decimals:6}},K={network:"eip155:42161",asset:"0xaf88d065e77c8cC2239327C5EDb3A432268e5831",metadata:{name:"USD Coin",symbol:"USDC",decimals:6}},Y={network:"eip155:137",asset:"0x2791bca1f2de4661ed88a30c99a7a9449aa84174",metadata:{name:"USD Coin",symbol:"USDC",decimals:6}},G={network:"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",asset:"EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",metadata:{name:"USD Coin",symbol:"USDC",decimals:6}},J={network:"eip155:1",asset:"0xdAC17F958D2ee523a2206206994597C13D831ec7",metadata:{name:"Tether USD",symbol:"USDT",decimals:6}},z={network:"eip155:10",asset:"0x94b008aA00579c1307B0EF2c499aD98a8ce58e58",metadata:{name:"Tether USD",symbol:"USDT",decimals:6}},Z={network:"eip155:42161",asset:"0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9",metadata:{name:"Tether USD",symbol:"USDT",decimals:6}},M={network:"eip155:137",asset:"0xc2132d05d31c914a87c6611c10748aeb04b58e8f",metadata:{name:"Tether USD",symbol:"USDT",decimals:6}},X={network:"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",asset:"Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB",metadata:{name:"Tether USD",symbol:"USDT",decimals:6}},V={network:"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",asset:"native",metadata:{name:"Solana",symbol:"SOL",decimals:9}},Q={ethereumETH:W,baseETH:$,baseUSDC:j,baseSepoliaETH:q,ethereumUSDC:B,arbitrumUSDC:K,polygonUSDC:Y,solanaUSDC:G,ethereumUSDT:J,optimismUSDT:z,arbitrumUSDT:Z,polygonUSDT:M,solanaUSDT:X,solanaSOL:V};function ee(s){return Object.values(Q).filter(t=>t.network===s)}const te=0,b={paymentAsset:null,amount:10,tokenAmount:0,priceLoading:!1,error:null,exchanges:[],isLoading:!1,currentPayment:void 0,isPaymentInProgress:!1,paymentId:"",assets:[]},e=D(b),m={state:e,subscribe(s){return I(e,()=>s(e))},subscribeKey(s,t){return v(e,s,t)},resetState(){Object.assign(e,{...b})},async getAssetsForNetwork(s){const t=ee(s),n=await m.getAssetsImageAndPrice(t),a=t.map(r=>{var i,d,y,w;const c=r.asset==="native"?U():`${r.network}:${r.asset}`,o=n.find(A=>{var h,g,E;return((E=(g=(h=A.fungibles)==null?void 0:h[0])==null?void 0:g.address)==null?void 0:E.toLowerCase())===c.toLowerCase()});return{...r,price:((d=(i=o==null?void 0:o.fungibles)==null?void 0:i[0])==null?void 0:d.price)||1,metadata:{...r.metadata,iconUrl:(w=(y=o==null?void 0:o.fungibles)==null?void 0:y[0])==null?void 0:w.iconUrl}}});return e.assets=a,a},async getAssetsImageAndPrice(s){const t=s.map(a=>a.asset==="native"?U():`${a.network}:${a.asset}`);return await Promise.all(t.map(a=>N.fetchTokenPrice({addresses:[a]})))},getTokenAmount(){var t;if(!((t=e==null?void 0:e.paymentAsset)!=null&&t.price))throw new Error("Cannot get token price");const s=new Intl.NumberFormat("en-US",{minimumFractionDigits:0,maximumFractionDigits:8}).format(e.amount/e.paymentAsset.price);return Number(s)},setAmount(s){var t;e.amount=s,(t=e.paymentAsset)!=null&&t.price&&(e.tokenAmount=m.getTokenAmount())},setPaymentAsset(s){e.paymentAsset=s},isPayWithExchangeEnabled(){var s,t,n;return((s=u.state.remoteFeatures)==null?void 0:s.payWithExchange)||((t=u.state.remoteFeatures)==null?void 0:t.payments)||((n=u.state.features)==null?void 0:n.pay)},isPayWithExchangeSupported(){return m.isPayWithExchangeEnabled()&&C.state.activeCaipNetwork&&x.PAY_WITH_EXCHANGE_SUPPORTED_CHAIN_NAMESPACES.includes(C.state.activeCaipNetwork.chainNamespace)},async fetchExchanges(){try{const s=m.isPayWithExchangeSupported();if(!e.paymentAsset||!s){e.exchanges=[],e.isLoading=!1;return}e.isLoading=!0;const t=await L({page:te,asset:P(e.paymentAsset.network,e.paymentAsset.asset),amount:e.amount.toString()});e.exchanges=t.exchanges.slice(0,2)}catch{throw S.showError("Unable to get exchanges"),new Error("Unable to get exchanges")}finally{e.isLoading=!1}},async getPayUrl(s,t){try{const n=Number(t.amount),a=await R({exchangeId:s,asset:P(t.network,t.asset),amount:n.toString(),recipient:`${t.network}:${t.recipient}`});return f.sendEvent({type:"track",event:"PAY_EXCHANGE_SELECTED",properties:{exchange:{id:s},configuration:{network:t.network,asset:t.asset,recipient:t.recipient,amount:n},currentPayment:{type:"exchange",exchangeId:s},source:"fund-from-exchange",headless:!1}}),a}catch(n){throw n instanceof Error&&n.message.includes("is not supported")?new Error("Asset not supported"):new Error(n.message)}},async handlePayWithExchange(s){try{if(!p.state.address)throw new Error("No account connected");if(!e.paymentAsset)throw new Error("No payment asset selected");const t=T.returnOpenHref("","popupWindow","scrollbar=yes,width=480,height=720");if(!t)throw new Error("Could not create popup window");e.isPaymentInProgress=!0,e.paymentId=crypto.randomUUID(),e.currentPayment={type:"exchange",exchangeId:s};const{network:n,asset:a}=e.paymentAsset,r={network:n,asset:a,amount:e.tokenAmount,recipient:p.state.address},c=await m.getPayUrl(s,r);if(!c){try{t.close()}catch(o){console.error("Unable to close popup window",o)}throw new Error("Unable to initiate payment")}e.currentPayment.sessionId=c.sessionId,e.currentPayment.status="IN_PROGRESS",e.currentPayment.exchangeId=s,t.location.href=c.url}catch{e.error="Unable to initiate payment",S.showError(e.error)}},async waitUntilComplete({exchangeId:s,sessionId:t,paymentId:n,retries:a=20}){const r=await m.getBuyStatus(s,t,n);if(r.status==="SUCCESS"||r.status==="FAILED")return r;if(a===0)throw new Error("Unable to get deposit status");return await new Promise(c=>{setTimeout(c,5e3)}),m.waitUntilComplete({exchangeId:s,sessionId:t,paymentId:n,retries:a-1})},async getBuyStatus(s,t,n){var a,r,c,o;try{if(!e.currentPayment)throw new Error("No current payment");const i=await O({sessionId:t,exchangeId:s});return e.currentPayment.status=i.status,(i.status==="SUCCESS"||i.status==="FAILED")&&(e.currentPayment.result=i.txHash,e.isPaymentInProgress=!1,f.sendEvent({type:"track",event:i.status==="SUCCESS"?"PAY_SUCCESS":"PAY_ERROR",properties:{source:"fund-from-exchange",paymentId:n,configuration:{network:((a=e.paymentAsset)==null?void 0:a.network)||"",asset:((r=e.paymentAsset)==null?void 0:r.asset)||"",recipient:p.state.address||"",amount:e.amount},currentPayment:{type:"exchange",exchangeId:(c=e.currentPayment)==null?void 0:c.exchangeId,sessionId:(o=e.currentPayment)==null?void 0:o.sessionId,result:i.txHash}}})),i}catch{return{status:"UNKNOWN",txHash:""}}},reset(){e.currentPayment=void 0,e.isPaymentInProgress=!1,e.paymentId="",e.paymentAsset=null,e.amount=0,e.tokenAmount=0,e.priceLoading=!1,e.error=null,e.exchanges=[],e.isLoading=!1}};export{m as E};
